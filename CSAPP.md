# chapter 7 链接

链接把各种代码和数据片段收集在一起，然后组合成一个单一文件。
这个单一文件可以被加载到内存中执行。

链接可以发生在编译时、加载时、运行时。

链接器使大型软件的分离式编译成为可能。

链接的知识可以解决一些问题：

    大型程序是如何构造的
    避免一些危险的编程错误：比如全局变量的不恰当定义导致的隐藏错误
    理解语言作用域规则的本质
    帮助理解一些重要的系统概念：加载和运行程序、虚拟内存、分页、内存映射
    共享库和动态链接增加了链接的复杂性

对链接的讨论有以下几点：
    
    传统的静态链接
    加载时的动态链接
    运行时共享库的动态链接

## 7.1 编译器驱动程序

`compiler driver`会调用`cpp(C语言预处理器)`、`cc1(C编译器)`、`as(汇编器器)`生成`目标文件`。

`ld(链接器)`将编译器生成的目标文件和一些必要的`系统目标文件`组合起来，创建一个`可执行文件`。

在`shell`中输出程序的名称，`loader(加载器)`会将可执行文件的代码和数据复制到`内存`，然后将`控制`转移到程序的开头。

## 7.2 静态链接

静态连接器：`static linker`

输入是可重定位目标文件和命令行参数；输出是可以加载和运行的可执行目标文件。

可重定位的目标文件是由多个代码和数据的`section(节)`组成的。
每一节都是一个连续的`字节序列`。

链接器必须完成2个任务：

    符号解析
    重定位

符号对应一个函数、全局变量、静态变量。
符号解析的目的是将对一个符号的引用和符号的定义关联起来。

重定位：

编译器和链接器生成从地址0开始的代码节和数据节。
链接器把每个符号的定义和一个内存位置关联起来，并修改对这些符号的引用，让他们指向对应的内存位置。

一些重要的事实：
目标文件纯粹是字节块的集合。

这些块包含程序代码、程序数据、或者是引导链接器和加载器的数据结构。

链接器将这些块连接起来、确定运行时的位置，并且修改块中的各种位置。

链接器对机器的了解很少，大部分工作是编译器和汇编器完成的。

## 7.3 目标文件

目标文件有3种形式：
    
    可重定位目标文件：可以在编译时与其他可重定位目标文件合并成可执行目标文件
    可执行目标文件：可以被直接复制进内存并执行
    共享目标文件：可以在加载或运行时被动态地加载进内存并链接

一个目标文件就是一个字节序列。
目标文件在不同的系统上有不同的格式：unix和linux中是ELF格式。

## 7.4 可重定位目标文件

典型的ELF可重定位文件的格式：

    ELF header
    section 1 //entry
    section 2
    ...
    section header table

- ELF header描述了系统的字的长度和大小端以及帮助链接器工作的信息。
- 中间的section有多种，每一节都是一个固定大小的entry。
- section header table描述不同节的位置和大小。


























